<script>
  import { beforeUpdate } from "svelte";
  import { stores } from "@sapper/app";
  import { crossfade, slide } from "svelte/transition";
  import { cubicInOut } from "svelte/easing";
  import { writable } from "svelte/store";

  import { mode, toggleMode, setModeTo } from "../theme.js";
  import Menu from "../components/Menu.svelte";

  let isMenuOpen = false;

  const toggleMenu = () => {
    isMenuOpen = !isMenuOpen;
  };

  const [send, recieve] = crossfade({
    delay: 0,
    duration: 200,
    fallback: slide,
    easing: cubicInOut
  });

  const { page } = stores();

  $: path = $page.path;

  const links = {
    "/": "home",
    "/writing": "writing",
    "/oss": "oss"
  };

  const isRoot = p => p === "/";
  const isCurrentPath = p => !isRoot(p) && path.startsWith(p);

  beforeUpdate(() => {
    let storedTheme;

    try {
      storedTheme = localStorage.getItem("theme");
    } catch (e) {}

    const darkQuery = window.matchMedia("(prefers-color-scheme: dark)");

    document.documentElement.setAttribute(
      "data-theme",
      storedTheme || (darkQuery.matches ? "dark" : "light")
    );

    setModeTo(storedTheme);

    darkQuery.addListener(e => {
      setModeTo(e.matches ? "dark" : "light");
    });

    const setPreferredTheme = () => {
      document.documentElement.setAttribute("data-theme", $mode);
      try {
        localStorage.setItem("theme", $mode);
      } catch (e) {}
    };

    mode.subscribe(setPreferredTheme);
  });
</script>

<style>
  :global(:root) {
    --bg: hsl(210, 20%, 99%);
    --primary: hsl(74, 32%, 8%);
    --secondary: hsl(206, 100%, 44%);
    --tertiary: hsl(206, 54%, 32%);
    font-size: min(18px, calc(1vw + 0.8em));
  }

  :global([data-theme="dark"]) {
    --bg: hsl(74, 32%, 8%);
    --primary: hsl(210, 20%, 99%);
    --secondary: hsl(206, 80%, 71%);
    --tertiary: hsl(206, 89%, 82%);
  }

  :global(*:focus) {
    outline: none;
    box-shadow: 0 0 0 3px var(--tertiary);
  }

  :global(body) {
    color: var(--primary);
    background-color: var(--bg);
    font-family: Inter, serif;
    transition: color, background-color 300ms ease-out;
  }

  :global(.grid > * + *) {
    margin-top: 1rem;
  }

  :global(a) {
    --link: linear-gradient(to bottom, transparent 70%, var(--secondary) 70.1%);
    --active: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 50%,
      var(--secondary) 50.1%
    );
    color: var(--primary);
  }

  :global(a:link) {
    background-image: var(--link);
    background-position: 0 70%;
    background-size: 100% 200%;
    word-break: break-word;
    transition: background-position 100ms;
  }

  :global(a:visited) {
    background-image: var(--link);
    background-position: 0 70%;
    background-size: 100% 200%;
    word-break: break-word;
    transition: background-position 100ms;
  }

  :global(a:hover) {
    background-image: var(--active);
    background-position: 0 100%;
  }

  :global(a:active) {
    background-image: var(--active);
    background-position: 0 100%;
  }

  .fix-scroll {
    padding-left: calc(100vw - 100%);
  }

  .max-width {
    max-width: 1024px;
    margin: 0 auto;
  }

  .header {
    padding: 0.5em 1em;
  }

  .flex-between {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header__author {
    font-size: 1.3rem;
    font-weight: bold;
    letter-spacing: 0.04em;
  }

  .header__controls {
    display: flex;
    align-items: center;
  }

  .bar {
    padding: 0.4em;
    background-image: linear-gradient(
      70deg,
      var(--secondary),
      var(--secondary) 45%,
      var(--primary) 45.1%,
      var(--primary)
    );
    background-size: 150% 150%;
    animation: gradient-left 30s ease infinite;
  }

  .bar + .bar {
    margin-top: 0.4em;
    background-image: linear-gradient(
      110deg,
      var(--secondary),
      var(--secondary) 50%,
      var(--primary) 50.1%,
      var(--primary)
    );
    animation: gradient-right 30s ease infinite;
  }

  .menu-button {
    display: block;
    position: relative;
    font-size: 3rem;
    width: 0.7em;
    height: 0.7em;
    margin-right: 0.5em;
    line-height: 0.4;
    text-indent: 5em;
    white-space: nowrap;
    overflow: hidden;
  }

  .menu-button::after {
    position: absolute;
    top: 0.1em;
    left: 0.1em;
    display: block;
    content: "\2261";
    text-indent: 0;
  }

  .gradient {
    background: linear-gradient(
      138deg,
      var(--primary) 20%,
      var(--tertiary) 20.1%,
      var(--tertiary) 85%,
      var(--primary) 85.1%
    );
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .mode-toggle {
    margin-top: 0;
    position: relative;
  }

  .pc-navigation__pointer {
    position: absolute;
    border-radius: 50%;
    background-color: var(--secondary);
    height: 0.5em;
    width: 0.5em;
    top: 1.8em;
    left: 2em;
  }

  .pc-navigation {
    display: none;
  }

  .pc-navigation > ul {
    display: flex;
    list-style: none;
  }

  .pc-navigation > ul > * + * {
    margin-left: 1.5em;
  }

  .pc-navigation__link {
    position: relative;
  }

  .pc-navigation__link > a {
    display: block;
    padding: 0 0.8em;
    font-weight: bold;
    text-decoration: none;
    letter-spacing: 0.03em;
  }

  .pc-navigation__link > a:link,
  .pc-navigation__link > a:visited {
    color: var(--primary);
    background: none;
  }

  .pc-navigation__link > a:hover,
  .pc-navigation__link > a:active {
    color: var(--secondary);
  }

  .divider {
    margin-top: 0.8em;
  }

  @media screen and (min-width: 1024px) {
    .pc-navigation {
      display: flex;
      font-size: 1.1rem;
      margin-right: 3em;
    }

    .menu-button {
      display: none;
    }

    .divider {
      margin-top: 1.3em;
    }

    .header__author {
      font-size: 1.8rem;
    }
  }

  .mode-toggle__toggle--dark {
    transition: transform 300ms ease-out;
    transform: rotate(0deg);
  }

  .mode-toggle__toggle--light {
    transition: transform 300ms ease-out;
    transform: rotate(360deg);
  }

  .mode-toggle__toggle {
    cursor: pointer;
    display: block;
  }

  .mode-toggle__toggle > input {
    display: none;
  }

  .mode-toggle__toggle > div {
    border-radius: 50%;
    display: grid;
    place-items: center;
  }

  .mode-toggle__toggle > div > div {
    width: 30px;
    height: 30px;
    border: 2px solid var(--primary);
    background: linear-gradient(
      to right,
      var(--bg),
      var(--bg) 50%,
      var(--primary) 50%
    );
    border-radius: 50%;
    display: grid;
    place-items: center;
    transition: background-position 500ms;
  }

  .mode-toggle__toggle > div > div > div {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: linear-gradient(
      to left,
      var(--bg),
      var(--bg) 50%,
      var(--primary) 50%
    );
  }

  .grid {
    display: grid;
    grid-template-rows: auto 1fr auto;
    grid-row-gap: 1rem;
    height: 100vh;
  }

  @keyframes gradient-right {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  @keyframes gradient-left {
    0% {
      background-position: 100% 50%;
    }
    50% {
      background-position: 0% 50%;
    }
    100% {
      background-position: 100% 50%;
    }
  }

  .min-height {
    min-height: 0.5em;
  }
</style>

<svelte:head>
  <script>
    (() => {
      try {
        const storedTheme = localStorage.getItem("theme");
        const darkQuery = window.matchMedia("(prefers-color-scheme: dark)");
        document.documentElement.setAttribute(
          "data-theme",
          storedTheme || (darkQuery.matches ? "dark" : "light")
        );
      } catch (e) {}
    })();
  </script>
</svelte:head>

<div class="grid fix-scroll">
  <header>
    <div class="max-width header flex-between">
      <h1 class="gradient header__author">Kirill Vasiltsov</h1>
      <div class="header__controls">
        <nav class="pc-navigation">
          <ul>
            {#each Object.keys(links) as link}
              <li class="pc-navigation__link">
                <a href={link}>{links[link]}</a>
                {#if (link === '/' && isRoot(path)) || isCurrentPath(link)}
                  <div in:send out:recieve class={`pc-navigation__pointer`} />
                {/if}
              </li>
            {/each}
          </ul>
        </nav>
        <button class="menu-button" on:click={toggleMenu}>MENU</button>
        <aside class="mode-toggle">
          <label
            class={`mode-toggle__toggle mode-toggle__toggle--${$mode === 'dark' ? 'dark' : 'light'}`}>
            <input
              checked={$mode === 'dark'}
              type="checkbox"
              on:change={toggleMode} />
            <div>
              <div>
                <div />
              </div>
            </div>
          </label>
        </aside>
      </div>
    </div>
    <aside class="divider">
      <div class="bar" />
      <div class="bar" />
    </aside>
  </header>
  <div class="content">
    <slot />
  </div>
  <footer>Footer</footer>
</div>
{#if isMenuOpen}
  <Menu {links} {toggleMenu} />
{/if}
